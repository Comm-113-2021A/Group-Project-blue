---
title: "Analysis of COVID Vaccine Distribution in Pennsylvania"
subtitle: ""
author: "Team Blue <br> Vinh Hau, Iris Lee, Jason Yan"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(showtext)
library(rvest)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, echo = FALSE}
  janssen <- read.csv("../data/janssen.csv")
  pfizer <- read.csv("../data/pfizer.csv")
  moderna <- read.csv("../data/moderna.csv")
```

```{r, echo = FALSE}
style_xaringan(
  title_slide_background_image = "img/confetti.jpg"
)
```


class: center, middle

## Are vaccines being distributed fairly within the US?

---

class: inverse, center, middle

# Data Tidying

---

# Initial Data Sets

- Vaccination Data recieved from CDC

- Data on vaccines came in 3 different different data sets. 

---

# janssen.csv

```{r echo = FALSE}
glimpse(janssen)
```

---

# moderna.csv

```{r echo = FALSE}
glimpse(moderna)
```


---

# phizer.csv

```{r echo = FALSE}
glimpse(pfizer)
```

---

# Renaming Columns

```{r}
janssen <- janssen %>%
  rename(
    first_dose = "X1st.Dose.Allocations",
    # second_dose = "2nd Dose Allocations",
    week = "Week.of.Allocations",
    jurisdiction = "Jurisdiction"
  )
moderna <- moderna %>%
  rename(
    first_dose = "X1st.Dose.Allocations",
    second_dose = "X2nd.Dose.Allocations",
    week = "Week.of.Allocations",
    jurisdiction = "Jurisdiction"
  )
pfizer <- pfizer %>%
  rename(
    first_dose = "X1st.Dose.Allocations",
    second_dose = "X2nd.Dose.Allocations",
    week = "Week.of.Allocations",
    jurisdiction = "Jurisdiction"
  )
```

---

# Combining Data

- We wish to combine the data into one big dataset `vaccines.csv`. 

- First note that the janssen vaccine only has 1 dose. We can fix this with a `mutate` call

```{r}
janssen_second_dose <- janssen %>%
  mutate(second_dose = 0)
glimpse(janssen_second_dose)
```

---


---

# moderna.csv

```{r echo = FALSE}
glimpse(moderna)
```


---

# phizer.csv

```{r echo = FALSE}
glimpse(pfizer)
```

---

# Renaming Columns

```{r}
janssen <- janssen %>%
  rename(
    first_dose = "X1st.Dose.Allocations",
    # second_dose = "2nd Dose Allocations",
    week = "Week.of.Allocations",
    jurisdiction = "Jurisdiction"
  )
moderna <- moderna %>%
  rename(
    first_dose = "X1st.Dose.Allocations",
    second_dose = "X2nd.Dose.Allocations",
    week = "Week.of.Allocations",
    jurisdiction = "Jurisdiction"
  )
pfizer <- pfizer %>%
  rename(
    first_dose = "X1st.Dose.Allocations",
    second_dose = "X2nd.Dose.Allocations",
    week = "Week.of.Allocations",
    jurisdiction = "Jurisdiction"
  )
```

---

# Combining Data

- We wish to combine the data into one big dataset `vaccines.csv`. 

- First note that the janssen vaccine only has 1 dose. We can fix this with a `mutate` call

```{r}
janssen_second_dose <- janssen %>%
  mutate(second_dose = 0)
glimpse(janssen_second_dose)
```

---

# Marking Vaccine

Then, we add a column called vaccine so we know what kind of vaccine it is after we combine the datasets. 
```{r}
janssen_second_dose <- janssen_second_dose %>%
  mutate(vaccine = "janssen")

pfizer <- pfizer %>%
  mutate(vaccine = "pfizer")

moderna <- moderna %>%
  mutate(vaccine = "moderna")
```

---

# Combine

- Then we combine the datasets into `vaccines` with `rbind`
```{r}
vaccines <- rbind(janssen_second_dose, moderna, pfizer)
glimpse(vaccines)
```

---

# Writing Data Set

- Finally we write out the dataset
```{r}
write_csv(vaccines, "../data/vaccines.csv")
```

---

Join 

---

# Combine

- Then we combine the datasets into `vaccines` with `rbind`
```{r}
vaccines <- rbind(janssen_second_dose, moderna, pfizer)
glimpse(vaccines)
```

---

# Writing Data Set

- Finally we write out the dataset
```{r}
write_csv(vaccines, "../data/vaccines.csv")
```


<!-- WRITE SOME STUFF ABOUT COMBINING VACCINE DEMOGRAPHIC HERE -->

class: inverse, middle, center

# Model

---
```{r}
vaccine_pop <- read_csv("../data/vaccine_pop.csv")
vaccine_pop <- vaccine_pop %>%
  mutate(week = as.Date(week, "%m/%d/%y"))
```

# Splitting the Data

```{r}
set.seed(1234)
library(tidymodels)
vaccine_split <- initial_split(vaccine_pop)
vaccine_train <- training(vaccine_split)
vaccine_test <- testing(vaccine_split)
dim(vaccine_train)
dim(vaccine_test)

```


---

# Specifying Model


```{r}

vaccine_mod <- linear_reg() %>%
  set_engine("lm")
# %>%
#   fit(first_dose ~ week + vaccine + white + black + asian + hispanic, data = vaccine_train)
# 
# vaccine_mod %>%
#   tidy()
vaccine_recipe <- recipe(first_dose ~ week + vaccine + white + black + asian + hispanic,
                         data = vaccine_train) %>%
  step_zv(all_predictors())

vaccine_wflow <- workflow() %>%
  add_model(vaccine_mod) %>%
  add_recipe(vaccine_recipe)

```


---

# Fitting Model

```{r boring-regression}
vaccine_fit <- vaccine_wflow %>%
  fit(data = vaccine_train)
vaccine_fit %>%
  tidy()
```

---

# Evaluate Model


```{r}
vaccine_train_pred <- predict(vaccine_fit, vaccine_train) %>%
  bind_cols(data = vaccine_train %>% select(first_dose, location))
vaccine_train_pred
```

---

# Residual Graph
```{r, echo=FALSE}
vaccine_mod_fitted <- vaccine_mod %>% 
  fit(first_dose ~ week + vaccine + white + black + asian + hispanic, data = vaccine_train)
vaccine_aug <- augment(vaccine_mod_fitted$fit)

vaccine_aug %>%
  ggplot(aes(x=.fitted, y=.resid)) +
  geom_point()
```


---

# R^2
```{r}
rmse(vaccine_train_pred, truth = first_dose, estimate = .pred)
rsq(vaccine_train_pred, truth = first_dose, estimate = .pred)
```



---


```{r}
vaccine_test_pred <- predict(vaccine_fit, vaccine_test) %>%
  bind_cols(data = vaccine_test %>% select(first_dose, location))
vaccine_test_pred
```

---

# R^2
```{r}
rmse(vaccine_test_pred, truth = first_dose, estimate = .pred)
rsq(vaccine_test_pred, truth = first_dose, estimate = .pred)



```
